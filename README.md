# ЖКХ-CalculаTor

Счётчик и калькулятор стоимости коммунальных услуг (горячая / холодная вода, канализация, электричество).
Проект на Python + CustomTkinter для локальных расчётов и ведения истории.

---

## Ключевые изменения (важно)

1. **Приоритет расчёта горячей воды — формула «по квитанции":**  
   \[\text{стоимость горячей} = V \times \text{hot\_water\_table\_component} + V \times \text{thermal\_conversion} \times \text{thermal\_tariff\_gcal}\]  
   — если в `config.json` присутствуют все три поля: `hot_water_table_component`, `thermal_conversion`, `thermal_tariff_gcal`, именно они используются.

2. **Вычисления идут без внутренних округлений.** Это сохраняет максимальную точность; форматирование вывода (например, отображение с 2 знаками) отделено от самих вычислений и может быть настроено отдельно.

3. **Backward fallback:** если полей для формулы по квитанции нет, используется единый тариф `hot_water` (если он указан). Поле `hot_water_components` (вида `{ water_component, thermal_component }`) **больше не используется** как приоритет — оно считается устаревшим/историческим и будет игнорироваться, если заданы квитанционные поля.

4. Исправлены UI-методы (включая `_reset_form`) и улучшено сохранение истории.

---

## Формула «по квитанции» — объяснение и единицы

Для корректного использования формулы нужно убедиться в единицах величин в квитанции:

- `hot_water_table_component` — ₽/м³ (водная часть тарифа, строка «компонент на х/в, ₽/м³").
- `thermal_conversion` — Гкал/м³ (коэффициент перевода объёма воды в тепловую энергию) — уточните в квитанции единицы.
- `thermal_tariff_gcal` — ₽/Гкал (тариф на тепловую энергию).

Итоговый тариф на 1 м³:

```
tariff_per_m3 = hot_water_table_component + thermal_conversion * thermal_tariff_gcal
```

---

## Пример конфигурации (рекомендуемый — «по квитанции")

`config.json`:

```json
{
  "coefficients": {
    "hot_water_table_component": 34.74,
    "thermal_conversion": 0.06508,
    "thermal_tariff_gcal": 2715.13,
    "cold_water": 41.0,
    "sewage": 28.1,
    "electricity": 4.95,
    "hot_water": 211.4406604
  },
  "ui": {
    "theme": "dark",
    "color_theme": "blue"
  }
}
```

> Рекомендация: положить `hot_water` равным вычисленному тарифу, чтобы при отсутствии полей «по квитанции" программа корректно падала в fallback.

---

## Устаревший пример (не рекомендуется)

Ранее проект поддерживал `hot_water_components`:

```json
"hot_water_components": {
  "water_component": 32.02,
  "thermal_component": 154.35
}
```

Если вы используете новую конфигурацию «по квитанции", это поле можно удалить — оно не учитывается при наличии `hot_water_table_component + thermal_conversion + thermal_tariff_gcal`.

---

## Пример расчёта (без внутренних округлений)

Дано (из квитанции):
- \(V = 3.7\) м³  
- `hot_water_table_component` = 34.74 ₽/м³  
- `thermal_conversion` = 0.06508 Гкал/м³  
- `thermal_tariff_gcal` = 2715.13 ₽/Гкал

Вычисления:

```
thermal_part_per_m3 = 0.06508 * 2715.13 = 176.7006604 ₽/м³
tariff_per_m3 = 34.74 + 176.7006604 = 211.4406604 ₽/м³

cost_hot = 3.7 * 34.74 + 3.7 * 0.06508 * 2715.13
         = 128.538    + 653.803304  = 782.341304 ₽
```

(В интерфейсе вы можете отобразить результат с нужным форматированием, например `782.34 ₽`, но внутренние вычисления сохраняют точность.)

---

## Быстрый старт (установка и запуск)

```bash
git clone https://github.com/MrAsavik/jkx_calculator.git
cd jkx_calculator
python -m pip install --upgrade pip
pip install -r requirements.txt
# Запуск: укажите файл-скрипт проекта. По умолчанию:
python jkx_calculator.py
# или, если в репозитории есть main.py:
python main.py
```

---

## Использование

1. Откройте приложение.
2. Введите текущие показания счётчиков (горячая, холодная, электричество).
3. Нажмите **Рассчитать стоимость**.
4. Смотрите результат с детализацией по компонентам горячей воды (если используются поля «по квитанции"), а также запись в истории.

---

## Тестирование и валидация

- Для проверки расчётов используйте реальные строки квитанции.  
- Если вы хотите получать точь-в-точь совпадение с печатной квитанцией, уточните правило округления у поставщика. По умолчанию внутренние расчёты выполняются без округлений — отображение можно округлить при выводе (UI), но не в самих формулах.

---

## Советы по конфигу и отладке

- Всегда фиксируйте единицы `thermal_conversion` и `thermal_tariff_gcal` в README/README.local — это поможет избежать ошибок.
- Если в квитанции сумма на 1 м³ явно отличается от произведения `table_component + conversion*tariff`, скорее всего в квитанции использован другой `table_component` или есть дополнительные сборы/компенсации. Сверяйте строку таблицы полностью.
- Для аудита можно временно включить вывод промежуточных значений (Q_raw, water_cost, thermal_cost) в лог.

---

## Разработка и тесты

- Код оформлен в OOP-стиле; логика расчётов выделена в отдельной функции `calculate_utility_cost` — её удобно покрывать unit-тестами (pytest).
- Пример теста (pytest) должен проверять:
  - корректность формулы «по квитанции»,
  - корректность fallback на `hot_water`,
  - поведение при отрицательных/меньших показаниях (исключение).

---

## Changelog (кратко)

- Приоритет расчёта: **формула по квитанции** (`hot_water_table_component` + `thermal_conversion` × `thermal_tariff_gcal`).
- Внутренние вычисления — **без округлений**.
- Устаревшее: `hot_water_components` больше не влияет при наличии квитанционных полей.
- UI: добавлен `_reset_form`, улучшены сообщения об ошибках и формат вывода (высокая точность в расчётах).

---

## Лицензия
MIT License © 2025 yourname
